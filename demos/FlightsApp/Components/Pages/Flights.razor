@page "/flights"
@using FlightsApp.Data.Model;
@using FlightsApp.Data.Service
@inject IFlightsService FlightsService
<h3>Flight Finder</h3>

<!-- 搜索区域 -->
<div class="search-panel">
    <label>From: </label>
    <input @bind="fromLocation" />

    <label>To: </label>
    <input @bind="toLocation" />

    <label>Day: </label>
    <input @bind="day" />

    <button @onclick="FindFlights">Find flights</button>
</div>

<!-- 航班列表区域 -->
<div class="flights-panel">
    <h4>Flights</h4>

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (flights is not null && flights.Count > 0)
    {
        <table>
            <thead>
                <tr>
                    <th>Flight Code</th>
                    <th>Airline</th>
                    <th>Day</th>
                    <th>Time</th>
                    <th>Cost</th>
                    <th>Select</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var flight in flights)
                {
                    <tr>
                        <td>@flight.FlightCode</td>
                        <td>@flight.Airline</td>
                        <td>@flight.Day</td>
                        <td>@flight.Time</td>
                        <td>@flight.Cost</td>
                        <td>
                            <button @onclick="@(() => SelectFlight(flight))">Select</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else if (flights is not null && flights.Count == 0)
    {
        <p>No flights found.</p>
    }
</div>

<!-- 预订区域 -->
<div class="reserve-panel">
    <h4>Reserve</h4>

    <div>
        <label>Flight code: </label>
        <input @bind="selectedFlightCode" disabled />
    </div>
    <div>
        <label>Airline: </label>
        <input @bind="selectedAirline" disabled />
    </div>
    <div>
        <label>Day: </label>
        <input @bind="selectedDay" disabled />
    </div>
    <div>
        <label>Time: </label>
        <input @bind="selectedTime" disabled />
    </div>
    <div>
        <label>Cost: </label>
        <input @bind="selectedCost" disabled />
    </div>
    <div>
        <label>Name: </label>
        <input @bind="passengerName" />
    </div>
    <div>
        <label>Citizenship: </label>
        <input @bind="passengerCitizenship" />
    </div>

    <button @onclick="ReserveFlight">Reserve</button>

    <p>Reservation Code: @reservationCode</p>
</div>

@code {
    // 搜索条件
    private string fromLocation = "Any";
    private string toLocation = "Any";
    private string day = "Any";

    // 加载状态
    private bool isLoading = false;

    // 航班列表
    private List<Flight>? flights;

    // 选中的航班信息 & 预订表单
    private string? selectedFlightCode;
    private string? selectedAirline;
    private string? selectedDay;
    private string? selectedTime;
    private decimal selectedCost;

    private string? passengerName;
    private string? passengerCitizenship;
    private string? reservationCode;

    // 点击“Find flights”时触发的异步方法
    private async Task FindFlights()
    {
        isLoading = true;
        // 调用 IFlightsService.SearchFlightsAsync
        flights = await FlightsService.SearchFlightsAsync(fromLocation, toLocation, day);
        isLoading = false;
    }

    // 选择某个航班后，将航班信息填入右侧的表单
    private void SelectFlight(Flight flight)
    {
        selectedFlightCode = flight.FlightCode;
        selectedAirline = flight.Airline;
        selectedDay = flight.Day;
        selectedTime = flight.Time;
        selectedCost = flight.Cost;
    }

    // 点击“Reserve”时触发的异步方法
    private async Task ReserveFlight()
    {
        if (string.IsNullOrWhiteSpace(selectedFlightCode)
            || string.IsNullOrWhiteSpace(passengerName))
        {
            // 这里可进行更多的输入验证或错误提示
            return;
        }

        // 调用服务完成预订，返回 Reservation Code
        reservationCode = await FlightsService.ReserveFlightAsync(
            selectedFlightCode,
            passengerName,
            passengerCitizenship
        );
    }
}
